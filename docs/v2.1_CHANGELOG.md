# Sovereign v2.1 — Delta Changelog

**Date:** 2026-02-06
**Agent:** Claude Opus 4.6 (Lead Architect)

## P0: White Screen & Build Fix

### Root Cause
Framer Motion's `initial` prop renders `style="opacity:0"` in SSR HTML.
If client-side JS fails or is delayed, the entire page stays invisible.

### Fixes Applied
- **`next.config.mjs`**: Removed static `import bundleAnalyzer` (breaks Vercel if devDependency unavailable). Now uses conditional `await import()` only when `ANALYZE=true`.
- **`PageWrapper.tsx`**: Added `isMounted` guard — uses `initial={false}` on SSR to render content visible, then enables animation after hydration.
- **`dashboard/page.tsx`**: All `motion.div` containers use `initial={isMounted ? 'hidden' : false}` pattern. SSR renders visible content; client animates.
- **Removed `X-XSS-Protection` header**: Deprecated header, removed from security headers.

## P1: Dashboard Live Data

### Before → After
| Element | Before (hardcoded) | After (store) |
|---------|-------------------|---------------|
| Transaction count | `12` | `expenses.length` |
| Goal count | `3` | `getActiveGoals().length` |
| Savings rate | `%25` | `getSavingsRate()` |
| Savings progress | `%83` | `Math.min((savingsRate / 30) * 100, 100)` |
| Progress text | `Hedefe %83 ulastin` | Dynamic or "Gelir ekleyerek tasarruf takibini baslatin" |

## P1: Oracle AI Contextual Flow

### Architecture
- **5 suggestion contexts**: `home`, `spending`, `health`, `goals`, `savings`
- **`SUGGESTION_MAP`**: Each context has 3-4 relevant follow-up suggestions
- **`getNextContext(query)`**: NLP-lite routing based on Turkish keyword matching
- **Always-visible suggestions**: Suggestions no longer disappear after first use — they update contextually
- **Ana Menü button**: `RotateCcw` icon resets to home context from any sub-topic

### User Flow
```
[Open Chat] → home suggestions
  → "Bu ay ne kadar harcadim?" → spending suggestions + Ana Menü
    → "Gecen aya gore degisim ne?" → spending (stays contextual)
    → [Ana Menü] → home suggestions
```

## P1: Motion System Revision

### Spring Config Changes
| Preset | Before | After | Rationale |
|--------|--------|-------|-----------|
| `gentle` | stiffness:120, damping:14 | stiffness:170, damping:26, mass:1 | Less wobbly, more controlled |
| `snappy` | stiffness:300, damping:20 | stiffness:400, damping:30, mass:0.8 | Faster response, no overshoot |
| `bouncy` | stiffness:400, damping:10 | stiffness:500, damping:15, mass:0.6 | Tighter overshoot |
| NEW `heavy` | — | stiffness:200, damping:28, mass:1.2 | Weighty (tok) for drawers/sheets |

### Additional Tuning
- Stagger: `0.06s → 0.07s` (slightly more deliberate cascade)
- Delay: `0.1s → 0.05s` (faster content appearance)
- Reveal Y offset: `30px → 24px` (subtler entrance)
- Hover lift: `-4px → -3px` (less dramatic)
- Scale-on-hover: `1.02 → 1.015` (barely perceptible = premium)

## Build Metrics

| Metric | v2.0 | v2.1 |
|--------|------|------|
| Dashboard First Load | 148kB | 150kB |
| SSR white screen | Present | Fixed |
| Build errors | 0 | 0 |
| Lint warnings | 0 | 0 |
| Type errors | 0 | 0 |

## Files Changed (7 files)

- `next.config.mjs` — Conditional bundle-analyzer, removed X-XSS-Protection
- `src/components/ui/PageWrapper.tsx` — Hydration-safe animation
- `src/app/(dashboard)/dashboard/page.tsx` — Live store data, SSR fix
- `src/components/features/ai/AIAssistant.tsx` — Contextual suggestion engine
- `src/lib/motion.ts` — Apple-grade spring tuning
- `docs/v2.1_CHANGELOG.md` — This file
- `docs/ROADMAP.md` — Updated status
